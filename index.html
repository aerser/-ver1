<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ファイルアップロード & ユーザーログイン</title>
</head>
<body>
    <h2>ユーザーログイン</h2>
    <input type="text" id="username" placeholder="ユーザー名">
    <button onclick="login()">ログイン</button>
    <button onclick="logout()">ログアウト</button>
    <p id="loginStatus">未ログイン</p>

    <h2>ファイルアップロード & ダウンロード</h2>
    <input type="file" id="fileInput">
    <button onclick="uploadFile()">アップロード</button>
    <h3>アップロードされたファイル</h3>
    <ul id="fileList"></ul>

    <script>
        let fileDB = [];
        let currentUser = localStorage.getItem('currentUser') || null;
        
        function login() {
            const username = document.getElementById('username').value;
            if (!username) {
                alert('ユーザー名を入力してください！');
                return;
            }
            currentUser = username;
            localStorage.setItem('currentUser', username);
            document.getElementById('loginStatus').innerText = `ログイン中: ${username}`;
            loadFiles();
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginStatus').innerText = '未ログイン';
            fileDB = [];
            displayFiles();
        }
        
        function uploadFile() {
            if (!currentUser) {
                alert('ログインしてください！');
                return;
            }
            
            const fileInput = document.getElementById('fileInput');
            if (fileInput.files.length === 0) return;
            
            const file = fileInput.files[0];
            
            // 既に同じファイル名がある場合はアップロードを拒否
            if (fileDB.some(f => f.name === file.name)) {
                alert('同じファイルはアップロードできません！');
                return;
            }
            
            const reader = new FileReader();
            
            reader.onload = function(event) {
                const fileData = {
                    name: file.name,
                    data: event.target.result,
                    user: currentUser
                };
                fileDB.push(fileData);
                localStorage.setItem(`files_${currentUser}`, JSON.stringify(fileDB));
                displayFiles();
            };
            
            reader.readAsDataURL(file);
        }
        
        function displayFiles() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';
            
            fileDB.forEach((file, index) => {
                const listItem = document.createElement('li');
                
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                link.textContent = file.name;
                
                const preview = document.createElement('img');
                preview.src = file.data;
                preview.style.width = '50px';
                preview.style.height = '50px';
                preview.style.marginLeft = '10px';
                
                listItem.appendChild(link);
                listItem.appendChild(preview);
                fileList.appendChild(listItem);
            });
        }
        
        function loadFiles() {
            if (!currentUser) return;
            document.getElementById('loginStatus').innerText = `ログイン中: ${currentUser}`;
            const storedFiles = localStorage.getItem(`files_${currentUser}`);
            if (storedFiles) {
                fileDB = JSON.parse(storedFiles);
                displayFiles();
            }
        }
        
        window.onload = loadFiles;
    </script>
</body>
</html>
